<!DOCTYPE html>
<html>
<head><title>Tests</title></head>
<body>
<h1>Tests</h1>
<div id="test1"></div>
<hr>
<div id="test2"></div>
<hr>
<div id="test3"></div>
<hr>
<div id="test4"></div>

<script src="constants.js"></script>
<script src="patterns/utils.js"></script>
<script src="patterns/decreasing.js"></script>
<script src="patterns/large-spike.js"></script>
<script src="patterns/small-spike.js"></script>
<script src="patterns/fluctuating.js"></script>
<script src="predictor.js"></script>

<script>
// Test 1: Temporal validation - Thursday PM without rise
const pred1 = new TurnipPredictor(107, {
  mon_am: 97, mon_pm: 92, tue_am: 87, tue_pm: 84,
  wed_am: 80, wed_pm: 75, thu_am: 70, thu_pm: 68
}, 'fluctuating');

const result1 = pred1.predict();

document.getElementById('test1').innerHTML = `
  <h2>Test 1: Temporal Validation (Thursday PM without rise)</h2>
  <p>Large Spike: ${result1.allProbabilities.large_spike}% (expected: 0%) ${result1.allProbabilities.large_spike === 0 ? '✅' : '❌'}</p>
  <p>Small Spike: ${result1.allProbabilities.small_spike}% (expected: 0%) ${result1.allProbabilities.small_spike === 0 ? '✅' : '❌'}</p>
  <p>Decreasing: ${result1.allProbabilities.decreasing}% (expected: 100%) ${result1.allProbabilities.decreasing === 100 ? '✅' : '❌'}</p>
  <h3>Rejection reasons:</h3>
  <pre>Large: ${pred1.rejectionReasons.large_spike.join('\n')}</pre>
  <pre>Small: ${pred1.rejectionReasons.small_spike.join('\n')}</pre>
`;

// Test 2: Rate drop validation (6 points)
const pred2 = new TurnipPredictor(107, {
  mon_am: 96, mon_pm: 91, tue_am: 87, tue_pm: 84,
  wed_am: 80, wed_pm: 76, thu_am: 73, thu_pm: 67
}, '');

const result2 = pred2.predict();

const thu_am_rate = 73 / 107;
const thu_pm_rate = 67 / 107;
const rateDrop = thu_am_rate - thu_pm_rate;

document.getElementById('test2').innerHTML = `
  <h2>Test 2: Rate Drop Validation (6 points)</h2>
  <h3>Calculation:</h3>
  <pre>Thu AM: 73 / 107 = ${thu_am_rate.toFixed(6)} (${(thu_am_rate * 100).toFixed(2)}%)
Thu PM: 67 / 107 = ${thu_pm_rate.toFixed(6)} (${(thu_pm_rate * 100).toFixed(2)}%)
Rate Drop: ${rateDrop.toFixed(6)} = ${(rateDrop * 100).toFixed(4)} points
Maximum: 0.05 (5 points)
Status: ${rateDrop > 0.05 ? '❌ EXCEEDS by ' + ((rateDrop - 0.05) * 100).toFixed(4) + ' points' : '✅ OK'}</pre>

  <h3>Results:</h3>
  <p>Pattern: ${result2.patternName} (${result2.confidence}%)</p>
  <p>Large Spike: ${result2.allProbabilities.large_spike}% (expected: 0%) ${result2.allProbabilities.large_spike === 0 ? '✅' : '❌'}</p>
  <p>Small Spike: ${result2.allProbabilities.small_spike}% (expected: 0%) ${result2.allProbabilities.small_spike === 0 ? '✅' : '❌'}</p>
  <p>Decreasing: ${result2.allProbabilities.decreasing}%</p>
  <p>Fluctuating: ${result2.allProbabilities.fluctuating}%</p>

  <h3>Rejection reasons:</h3>
  <pre>Large: ${pred2.rejectionReasons.large_spike.join('\n') || 'None'}</pre>
  <pre>Small: ${pred2.rejectionReasons.small_spike.join('\n') || 'None'}</pre>
`;

// Test 3: Período 2 Detection (Large Spike: Período 2 >= 140%)
const pred3 = new TurnipPredictor(107, {
  mon_am: 97,
  mon_pm: 92,
  tue_am: 87,
  tue_pm: 84,
  wed_am: 80,
  wed_pm: 76,
  thu_am: 73,
  thu_pm: 120,  // Período 1 del pico (inicio, subida >10%)
  fri_am: 160   // Período 2: 160/107 = 149.5% >= 140% -> Large Spike!
}, '');

const result3 = pred3.predict();

document.getElementById('test3').innerHTML = `
  <h2>Test 3: Período 2 Detection (Large Spike)</h2>
  <h3>Scenario:</h3>
  <pre>Thu PM: 120 (Período 1 del pico, subida de 73 -> 120)
Fri AM: 160 (Período 2 = 149.5% >= 140%)</pre>

  <h3>Results:</h3>
  <p>Pattern: ${result3.patternName} (${result3.confidence}%)</p>
  <p>Large Spike: ${result3.allProbabilities.large_spike}% (expected: high, Período 2 >= 140%)</p>
  <p>Small Spike: ${result3.allProbabilities.small_spike}% (expected: 0%, should be rejected) ${result3.allProbabilities.small_spike === 0 ? '✅' : '❌'}</p>

  <h3>Rejection reasons:</h3>
  <pre>Large: ${pred3.rejectionReasons.large_spike.join('\n') || 'None'}</pre>
  <pre>Small: ${pred3.rejectionReasons.small_spike.join('\n') || 'None (should show: Período 2 >= 140% = Large Spike)'}</pre>

  <h3>Expected:</h3>
  <p>✅ Small Spike should be rejected because Período 2 (160) is 149.5% >= 140%</p>
  <p>✅ Large Spike should remain possible or be confirmed</p>
`;

// Test 4: Small Spike - Period 4 calculation directa
// Testear directamente la función de cálculo de Small Spike
const knownPrices4 = [
  { index: 0, price: 85 },  // mon_am
  { index: 1, price: 81 },  // mon_pm (caída de 4% del rate: 85->81)
  { index: 2, price: 77 },  // tue_am (caída de 4% del rate: 81->77)
  { index: 3, price: 101 }, // tue_pm - pico empieza (período 1, subida 31% >= 30%)
  { index: 4, price: 120 }, // wed_am - período 2 (120% < 140%)
  { index: 5, price: 149 }, // wed_pm - período 3
];

// Calcular directamente para período 4 (thu_am = index 6)
const period4Range = calculateSmallSpikePattern(6, 100, knownPrices4);

// Debug: detectar peakStart
const detectedPeakStart = detectSpikePeakStart(knownPrices4, PERIODS.SMALL_SPIKE_PEAK_START_MIN, PERIODS.SPIKE_PEAK_START_MAX, false);

// También probar con predictor completo
const pred4 = new TurnipPredictor(100, {
  mon_am: 85,
  mon_pm: 81,
  tue_am: 77,
  tue_pm: 101,
  wed_am: 120,
  wed_pm: 149,
}, '');

const result4 = pred4.predict();

document.getElementById('test4').innerHTML = `
  <h2>Test 4: Small Spike - Período 4 ajustado según Período 3</h2>
  <h3>Scenario:</h3>
  <pre>Base: 100 bayas
Mon AM: 85  (85%, fase baja)
Mon PM: 81  (81%, caída de 4% del rate)
Tue AM: 77  (77%, caída de 4% del rate)
Tue PM: 101 (101%, Período 1 del pico, subida 31%)
Wed AM: 120 (120%, Período 2 < 140% → Small Spike)
Wed PM: 149 (149%, Período 3)
Thu AM: ??? (Período 4: DEBE ser >= 150)</pre>

  <h3>Debug Info:</h3>
  <p>Detected peakStart: ${detectedPeakStart} (expected: 3 = Tue PM)</p>
  <p>Period 3 should be at index: ${detectedPeakStart + 2} = ${detectedPeakStart + 2 === 5 ? '✅ (index 5 = Wed PM)' : '❌'}</p>

  <h3>Direct Calculation (calculateSmallSpikePattern):</h3>
  <p>Período 4 Min: ${period4Range.min} bayas ${period4Range.min >= 150 ? '✅' : '❌ (expected >= 150)'}</p>
  <p>Período 4 Max: ${period4Range.max} bayas ${period4Range.max <= 200 ? '✅' : '❌ (expected <= 200)'}</p>

  <h3>Full Predictor Results:</h3>
  <p>Pattern: ${result4.patternName} (${result4.confidence}%)</p>
  <p>Small Spike: ${result4.allProbabilities.small_spike}%</p>
  <p>Large Spike: ${result4.allProbabilities.large_spike}%</p>

  <h3>Small Spike Rejection Reasons:</h3>
  <pre>${pred4.rejectionReasons.small_spike.join('\\n') || 'None'}</pre>

  <h3>Expected:</h3>
  <p>✅ Cálculo directo debe mostrar min >= 150</p>
  <p>✅ Período 3 (149) + 1 = 150 mínimo</p>
`;
</script>
</body>
</html>
